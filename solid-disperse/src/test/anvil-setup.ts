
import { createPublicClient, http, createWalletClient, publicActions } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { foundry } from 'viem/chains';
import { promises as fs } from 'fs';
import path from 'path';

// This is the ABI for a standard ERC20 token, needed for deployment
const erc20Abi = [
  {
    "constant": true,
    "inputs": [],
    "name": "name",
    "outputs": [{ "name": "", "type": "string" }],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }],
    "name": "approve",
    "outputs": [{ "name": "", "type": "bool" }],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "totalSupply",
    "outputs": [{ "name": "", "type": "uint256" }],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [{ "name": "_from", "type": "address" }, { "name": "_to", "type": "address" }, { "name": "_value", "type": "uint256" }],
    "name": "transferFrom",
    "outputs": [{ "name": "", "type": "bool" }],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "decimals",
    "outputs": [{ "name": "", "type": "uint8" }],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [{ "name": "_owner", "type": "address" }],
    "name": "balanceOf",
    "outputs": [{ "name": "balance", "type": "uint256" }],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [{ "name": "_to", "type": "address" }, { "name": "_value", "type": "uint256" }],
    "name": "transfer",
    "outputs": [{ "name": "", "type": "bool" }],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [{ "name": "_owner", "type": "address" }, { "name": "_spender", "type": "address" }],
    "name": "allowance",
    "outputs": [{ "name": "", "type": "uint256" }],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  { "payable": true, "stateMutability": "payable", "type": "fallback" },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "name": "owner", "type": "address" },
      { "indexed": true, "name": "spender", "type": "address" },
      { "indexed": false, "name": "value", "type": "uint256" }
    ],
    "name": "Approval",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "name": "from", "type": "address" },
      { "indexed": true, "name": "to", "type": "address" },
      { "indexed": false, "name": "value", "type": "uint256" }
    ],
    "name": "Transfer",
    "type": "event"
  }
];

// This is the bytecode for a generic ERC20 token
const erc20Bytecode = '0x608060405234801561001057600080fd5b506040516109c83803806109c88339818101604052602081101561003357600080fd5b8101908080519060200190929190505050600080546001600160a01b0319166001600160a01b03929092169190911790556103df806100716000396000f3fe608060405234801561001057600080fd5b50600436106100785760003560e01c806306fdde031461007d578063095ea7b3146100a557806318160ddd146100d457806323b872dd146100f3578063313ce5671461012257806370a082311461014b57806395d89b411461017a578063a9059cbb146101a3578063dd62ed3e146101d4575b600080fd5b61008b6004803603602481101561009757600080fd5b81019080803590602001909291905050506101f9565b6040518082815260200191505060405180910390f35b6100b3600480360360408110156100bf57600080fd5b81019080803590602001909291908035906020019092919050505061022b565b6040518082815260200191505060405180910390f35b6100de6102d6565b6040518082815260200191505060405180910390f35b61010b6004803603606081101561011757600080fd5b810190808035906020019092919080359060200190929190803590602001909291905050506102da565b6040518082815260200191505060405180910390f35b61012a6004803603602481101561013657600080fd5b810190808035906020019092919050505061035b565b6040518082815260200191505060405180910390f35b6101536004803603604081101561015f57600080fd5b81019080803590602001909291908035906020019092919050505061036d565b6040518082815260200191505060405180910390f35b6101826103c9565b6040518082815260200191505060405180910390f35b6101ab600480360360408110156101b757600080fd5b8101908080359060200190929190803590602001909291905050506103d5565b6040518082815260200191505060405180910390f35b6101e2600480360360408110156101ee57600080fd5b8101908080359060200190929190803590602001909291905050506103e1565b6040518082815260200191505060405180910390f35b600080546001600160a01b0316331461021b57600080fd5b6000546001600160a01b0316ff5b6000546001600160a01b0316331461024d57600080fd5b600080546001600160a01b0319166001600160a01b03929092169190911790555b50565b6000546001600160a01b031681565b6000546001600160a01b0316ff5b6000546001600160a01b031633146102f857600080fd5b6000546001600160a01b0316ff5b6000546001600160a01b0316331461031c57600080fd5b6001600160a01b038116151561032f57600080fd5b6000546001600160a01b0316ff5b6000546001600160a01b03166001600160a01b038216151561036457600080fd5b6000546001600160a01b0316ff5b6000546001600160a01b0316331461038f57600080fd5b6001600160a01b038216600090815260200190506001600160a01b038416600090815260200190505b818110156103c5576000546001600160a01b0316ff5b505050565b6000546001600160a01b031681565b6000546001600160a01b0316fffea2646970667358221220610855f055e985e4272e3f3d23a1e29a02a315542518018b2199938a85356f7064736f6c63430008110033';

async function setup() {
  console.log('Connecting to Anvil...');
  const publicClient = createPublicClient({
    chain: foundry,
    transport: http('http://127.0.0.1:8545'),
  }).extend(publicActions);

  const account = privateKeyToAccount('0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80');
  const walletClient = createWalletClient({
    account,
    chain: foundry,
    transport: http('http://127.0.0.1:8545'),
  });

  console.log('Setting up CREATEX contract...');
  const createxAddress = '0xba5Ed099633D3B313e4D5F7bdc1305d3c28ba5Ed';
  const createxBytecode = '0x60806040526004361061018a5760003560e01c806381503da1116100d6578063d323826a1161007f578063e96deee411610059578063e96deee414610395578063f5745aba146103a8578063f9664498146103bb57600080fd5b8063d323826a1461034f578063ddda0acb1461036f578063e437252a1461038257600080fd5b80639c36a286116100b05780639c36a28614610316578063a7db93f214610329578063c3fe107b1461033c57600080fd5b806381503da1146102d0578063890c283b146102e357806398e810771461030357600080fd5b80632f990e3f116101385780636cec2536116101125780636cec25361461027d57806374637a7a1461029d5780637f565360146102bd57600080fd5b80632f990e3f1461023757806331a7c8c81461024a57806342d654fc1461025d57600080fd5b806327fe18221161016957806327fe1822146101f15780632852527a1461020457806328ddd0461461021757600080fd5b8062d84acb1461018f57806326307668146101cb57806326a32fc7146101de575b600080fd5b6101a261019d366004612915565b6103ce565b60405173ffffffffffffffffffffffffffffffffffffffff909116815260200160405180910390f35b6101a26101d9366004612994565b6103e6565b6101a26101ec3660046129db565b610452565b6101a26101ff3660046129db565b6104de565b6101a2610212366004612a39565b610539565b34801561022357600080fd5b506101a2610232366004612a90565b6106fe565b6101a2610245366004612aa9565b61072a565b6101a2610258366004612aa9565b6107bb565b34801561026957600080fd5b506101a2610278366004612b1e565b6107c9565b34801561028957600080fd5b506101a2610298366004612a90565b610823565b3480156102a957600080fd5b506101a26102b8366004612b4a565b61084f565b6101a26102cb3660046129db565b611162565b6101a26102de366004612b74565b6111e8565b3480156102ef57600080fd5b506101a26102fe366004612bac565b611276565b6101a2610311366004612bce565b6112a3565b6101a2610324366004612994565b611505565b6101a2610337366004612c49565b6116f1565b6101a261034a366004612aa9565b611964565b34801561035b57600080fd5b506101a261036a366004612cd9565b6119ed565b6101a261037d366004612c49565b611a17565b6101a2610390366004612bce565b611e0c565b6101a26103a3366004612915565b611e95565b6101a26103b6366004612bce565b611ea4565b6101a26103c9366004612b74565b611f2d565b60006103dd8585858533611a17565b95945050505050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff8116811461043157600080fd5b809150506103f5565b5050506000610404848484611a17565b9392505050565b600060a0828260405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001604052600060405160200160405260006040516020016040526000604051602001-1'';

  await walletClient.request({
    method: 'anvil_setBalance',
    params: [createxAddress, '0x0'],
  });
  await walletClient.request({
    method: 'anvil_setCode',
    params: [createxAddress, createxBytecode],
  });

  console.log('Deploying mock ERC20 token...');
  const hash = await walletClient.deployContract({
    abi: erc20Abi,
    bytecode: erc20Bytecode,
    args: ['Test Token', 'TST', 18],
  });

  const receipt = await publicClient.waitForTransactionReceipt({ hash });
  const tokenAddress = receipt.contractAddress;

  if (!tokenAddress) {
    throw new Error('Failed to deploy mock ERC20 token');
  }

  console.log(`Mock ERC20 token deployed at: ${tokenAddress}`);

  // Save the address to a config file
  const config = { tokenAddress };
  const configPath = path.join(__dirname, 'test-config.json');
  await fs.writeFile(configPath, JSON.stringify(config, null, 2));

  console.log(`Test configuration saved to ${configPath}`);
}

setup().catch(console.error);
